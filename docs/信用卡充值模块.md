# 信用卡充值模块需求文档

## 模块概述

本模块处理用户通过信用卡进行充值的完整流程，包括前端表单验证、后端数据校验、信用卡信息匹配以及充值成功率控制等功能。

## 接口流程

### 1. 前端调用
- 用户在充值页面填写信用卡信息并点击"确认支付"
- 前端将表单数据发送到后端充值接口

### 2. 后端处理流程

#### 2.1 数据格式校验

| 字段 | 校验规则 | 错误提示 |
|------|----------|----------|
| 用户姓名 | 仅允许英文字母 | "姓名格式不正確" |
| 信用卡号 | 必须为16位数字 | "卡號需為16位數字" |
| 有效期 | 格式必须正确 | "有效期格式不正确" |
| 安全码 | 必须为3位数字 | "安全码需為3位數字" |

#### 2.2 信用卡信息匹配

1. **精确匹配校验**
   - 在信用卡表中查找完全匹配的信用卡信息
   - **匹配失败**：返回 "充值失敗 請聯繫發卡機構"

2. **状态校验**
   - 如果信用卡状态为"充值失败"
   - 返回 "充值失敗 請聯繫發卡機構"

#### 2.3 充值金额校验

在信用卡信息匹配成功后，进行充值金额校验：
- 比较充值金额与业务参数配置表中的 `max_recharge_amount`
- **充值金额超限**：返回 "充值失敗 請聯繫發卡機構"

#### 2.4 充值次数与成功率控制

根据信用卡的充值次数，使用不同的成功率进行充值：

| 充值次数 | 对应充值次数 | 使用的成功率 | 处理逻辑 |
|----------|--------------|--------------|----------|
| 0 | 第一次充值 | 第一次充值成功率 | 失败：状态变更为"充值失败"，返回错误信息；成功：充值次数变为1 |
| 1 | 第二次充值 | 第二次充值成功率 | 失败：状态变更为"充值失败"，返回错误信息；成功：充值次数变为2 |
| 2 | 第三次充值 | 第一次充值成功率 | 失败：状态变更为"充值失败"，返回错误信息；成功：充值次数变为3 |
| 3 | 第四次充值 | 第四次充值成功率（0%） | 充值必定失败，状态变更为"充值失败"，返回错误信息 |
| ≥4 | 第五次及以后充值 | 无需配置 | 充值必定失败，状态保持"充值失败" |

## 数据模型

### 信用卡表字段
- `card_number`: 信用卡号（16位数字）
- `cardholder_name`: 持卡人姓名（英文字母）
- `expiry_date`: 有效期
- `cvv`: 安全码（3位数字）
- `status`: 卡片状态（正常/充值失败）
- `recharge_count`: 充值次数

### 业务参数配置表
- `first_recharge_success_rate`: 第一次充值成功率
- `second_recharge_success_rate`: 第二次充值成功率
- `fourth_recharge_success_rate`: 第四次充值成功率（固定为0%）
- `max_recharge_amount`: 信用卡最大充值值

### 充值记录表字段
- `user_id`: 用户ID（外键关联用户表）
- `card_id`: 信用卡ID（外键关联信用卡表）
- `amount`: 充值金额
- `status`: 充值状态（成功/失败）
- `recharge_time`: 充值时间
- `transaction_id`: 交易流水号

## 错误处理

所有错误情况都返回统一的错误信息：
- "姓名格式不正確"
- "卡號需為16位數字"
- "有效期格式不正确"
- "安全码需為3位數字"
- "充值失敗 請聯繫發卡機構"

## 业务逻辑说明

1. **概率控制**：充值成功与否通过随机数与配置的成功率比较来决定
2. **状态管理**：一旦充值失败，信用卡状态永久标记为"充值失败"
3. **次数递增**：每次充值成功后，充值次数递增1
4. **充值金额校验**：充值前必须校验充值金额是否超过配置的最大充值值，超限则直接失败
5. **成功率循环**：
   - 第一次充值：使用第一次充值成功率
   - 第二次充值：使用第二次充值成功率
   - 第三次充值：使用第一次充值成功率
   - 第四次充值：使用第四次充值成功率（固定为0%，必定失败）
   - 第五次及以后：无需配置成功率，必定失败
6. **失败终止**：第四次充值失败后，后续所有充值请求都会直接返回失败，不再进行概率计算
7. **充值记录创建**：
   - 充值成功后，必须创建一条充值记录
   - 充值记录需关联对应的信用卡信息（card_id）
   - 记录包含用户ID、充值金额、状态、时间戳和交易流水号
   - 充值失败时也需创建记录，状态标记为失败

## 注意事项

- 所有校验必须在充值操作之前完成
- 充值操作必须是原子性的，避免并发问题
- 错误信息使用繁体中文，保持与系统一致
- 充值成功后需要更新用户余额等相关数据
- 充值记录必须与信用卡信息正确关联
- 交易流水号需要唯一生成，便于后续查询和对账
- 充值失败时也需要创建记录，用于审计和问题排查
- 充值金额校验必须在概率计算之前执行
- 最大充值值配置需要合理设置，避免误判正常充值
