# 充值记录模块需求文档

## 模块概述

本模块用于展示和管理用户的充值记录，提供充值历史查询、状态筛选、数据汇总等功能。用户可以通过此模块查看所有充值交易的详细信息，包括充值类型、订单号、金额、状态和时间等。

## 页面结构

### 1. 页面基本信息
- **页面标题**：潮創宇宙-充值紀錄
- **页面URL**：`/ui/recharge/history`
- **访问路径**：登录后点击"我的"->"充值紀錄"
- **页面布局**：响应式设计，深色主题

### 2. 页面组件

#### 2.1 汇总区域
- **位置**：页面顶部
- **功能**：显示用户充值统计信息
- **内容**：
  - 累计充值金额（格式：0.00）
  - 充值次数（格式：0）

#### 2.2 状态筛选标签
- **位置**：汇总区域下方
- **功能**：按状态筛选充值记录
- **标签选项**：
  - 全部（默认选中）
  - 待處理
  - 成功
  - 失敗
- **交互**：点击标签切换筛选条件，同时更新选中状态

#### 2.3 充值记录列表
- **位置**：页面主体区域
- **功能**：展示充值记录详情
- **每条记录包含**：
  - 充值类型图标（银行卡图标）
  - 充值类型名称（銀行卡充值）
  - 订单号（格式：CARD+时间戳+随机字符串）
  - 创建时间（格式：YYYY-MM-DD HH:MM:SS）
  - 充值金额（格式：+金额.00）
  - 状态标签（成功/失敗/待處理）

#### 2.4 状态标签样式
- **成功**：绿色背景（rgba(80,190,120,.28)），绿色文字（#bfffd8）
- **失敗**：红色背景（rgba(255,120,120,.28)），红色文字（#ffd4d4）
- **待處理**：灰色背景（rgba(255,255,255,.18)），灰色文字（#cfe7ff）

#### 2.5 空状态提示
- **条件**：当没有符合条件的充值记录时
- **内容**："沒有更多了"
- **样式**：居中显示，浅蓝色文字（#a8c4ff）

## 功能需求

### 1. 数据展示功能
- **需求描述**：展示用户的充值记录列表
- **功能要求**：
  - 按时间倒序排列最新记录
  - 显示完整的充值信息
  - 支持不同状态的记录显示
  - 空状态时显示友好提示

### 2. 状态筛选功能
- **需求描述**：根据充值状态筛选记录
- **功能要求**：
  - 支持全部、待處理、成功、失敗四种筛选条件
  - 点击标签立即更新列表内容
  - 更新汇总统计数据
  - 保持选中状态的视觉反馈

### 3. 数据汇总功能
- **需求描述**：显示充值统计信息
- **功能要求**：
  - 实时计算累计充值金额
  - 统计总充值次数
  - 根据筛选条件动态更新

### 4. 响应式设计
- **需求描述**：适配不同设备屏幕
- **功能要求**：
  - 移动端友好布局
  - 自适应内容宽度
  - 保持良好的可读性

## 接口需求

### 1. 获取充值记录接口
- **接口地址**：`/api/user/recharges`
- **请求方法**：GET
- **认证方式**：X-Session-Token
- **请求参数**：
  ```json
  {
    "status": "all|pending|success|fail" // 可选参数，默认为"all"
  }
  ```
- **响应数据**：
  ```json
  {
    "success": true,
    "total_amount": 1200.0,
    "total_count": 68,
    "list": [
      {
        "actual_amount": "20.0",
        "amount": "20.0",
        "created_at": "2026-01-04 16:57:28",
        "order_id": "CARD1767517048ca173686",
        "status": "success",
        "status_text": "成功",
        "type": "CARD",
        "type_name": "銀行卡充值"
      }
    ]
  }
  ```

### 2. 错误处理
- **认证失败**：返回401错误
- **服务器错误**：返回500错误
- **参数错误**：返回400错误

## 数据模型

### 1. 充值记录表字段
- `id`: 主键，自增
- `user_id`: 用户ID（外键关联用户表）
- `order_id`: 订单号（唯一标识符）
- `type`: 充值类型（CARD：银行卡充值）
- `type_name`: 充值类型名称（銀行卡充值）
- `amount`: 充值金额
- `actual_amount`: 实际到账金额
- `status`: 充值状态（success：成功、fail：失败、pending：待处理）
- `status_text`: 状态文本（成功、失败、待處理）
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 2. 用户表关联字段
- `id`: 用户ID
- `total_recharge_amount`: 累计充值金额
- `total_recharge_count`: 累计充值次数

## 前端实现

### 1. HTML结构
```html
<div class="wrap">
  <section class="section">
    <!-- 汇总区域 -->
    <div class="summary">
      <div>
        <div class="tit">累計充值</div>
        <div id="sumAmt" class="val">0.00</div>
      </div>
      <div>
        <div class="tit">充值次數</div>
        <div id="sumCnt" class="val">0</div>
      </div>
    </div>
    
    <!-- 状态筛选标签 -->
    <div class="tabs">
      <button class="btn active" data-s="all">全部</button>
      <button class="btn" data-s="pending">待處理</button>
      <button class="btn" data-s="success">成功</button>
      <button class="btn" data-s="fail">失敗</button>
    </div>
    
    <!-- 充值记录列表 -->
    <div id="list" class="list"></div>
  </section>
</div>
```

### 2. CSS样式
- **主题**：深色背景，蓝色调
- **布局**：网格布局，响应式设计
- **组件**：卡片式设计，圆角边框
- **交互**：悬停效果，点击反馈

### 3. JavaScript功能
```javascript
// 获取充值记录
function loadRecharges(status) {
  fetch('/api/user/recharges' + (status && status !== 'all' ? '?status=' + encodeURIComponent(status) : ''))
    .then(response => response.json())
    .then(data => {
      if (!data || !data.success) return;
      
      // 更新汇总信息
      document.getElementById('sumAmt').textContent = Number(data.total_amount || 0).toFixed(2);
      document.getElementById('sumCnt').textContent = data.total_count || 0;
      
      // 渲染列表
      const list = document.getElementById('list');
      list.innerHTML = '';
      
      const records = data.list || [];
      if (records.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#a8c4ff;padding:10px">沒有更多了</div>';
        return;
      }
      
      records.forEach(record => {
        const badgeClass = record.status === 'success' ? 'badge bd-success' : 
                          (record.status === 'fail' ? 'badge bd-fail' : 'badge bd-pending');
        const tag = record.status === 'success' ? '成功' : 
                  (record.status === 'fail' ? '失敗' : '待處理');
        
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <div class="logo">
            <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor">
              <path d="M3 5h18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2zm0 4h18V7H3zm0 2v6h18v-6z"/>
            </svg>
          </div>
          <div class="meta">
            <div class="name">${record.type_name || record.type || '充值'}</div>
            <div class="desc">訂單號：${record.order_id || ''}</div>
            <div class="desc">${record.created_at || ''}</div>
          </div>
          <div class="side">
            <div class="amt">+${record.amount || '0'}.00</div>
            <div class="${badgeClass}">${tag}</div>
          </div>
        `;
        list.appendChild(item);
      });
    })
    .catch(error => {
      console.error('获取充值记录失败:', error);
    });
}

// 标签切换事件
document.querySelectorAll('.tabs .btn').forEach(button => {
  button.addEventListener('click', function() {
    // 更新选中状态
    document.querySelectorAll('.tabs .btn').forEach(btn => {
      btn.classList.remove('active');
    });
    this.classList.add('active');
    
    // 加载对应状态的记录
    loadRecharges(this.dataset.s);
  });
});

// 初始化加载
loadRecharges('all');
```

## 业务逻辑

### 1. 数据加载逻辑
- 页面加载时自动获取全部充值记录
- 切换筛选标签时重新获取对应状态的记录
- 数据更新后实时刷新页面显示

### 2. 状态管理逻辑
- 成功状态：显示绿色标签，表示充值成功
- 失败状态：显示红色标签，表示充值失败
- 待处理状态：显示灰色标签，表示正在处理中

### 3. 数据统计逻辑
- 累计充值金额：所有成功充值记录的金额总和
- 充值次数：所有充值记录的总数量
- 统计数据根据筛选条件动态计算

### 4. 订单号生成规则
- 格式：CARD + 时间戳 + 随机字符串
- 示例：CARD1767517048ca173686
- 时间戳：10位数字（Unix时间戳）
- 随机字符串：8位字符

## 注意事项

### 1. 性能要求
- 支持大量数据的高效加载
- 分页加载机制（当前版本未实现）
- 数据缓存策略

### 2. 安全要求
- 必须用户登录后才能访问
- 接口调用需要有效的Session Token
- 防止SQL注入等安全攻击

### 3. 用户体验
- 页面加载显示loading状态
- 错误处理友好提示
- 响应式设计适配各种设备

### 4. 数据一致性
- 充值记录与用户余额数据保持一致
- 状态更新需要事务保证
- 定期数据校验和清理

### 5. 扩展性
- 支持多种充值类型的显示
- 预留分页功能接口
- 支持导出功能接口

### 6. 监控和日志
- 接口调用日志记录
- 异常情况监控报警
- 用户操作行为追踪

## 测试用例

### 1. 功能测试
- [ ] 验证页面正常加载
- [ ] 验证数据正确显示
- [ ] 验证状态筛选功能
- [ ] 验证汇总数据计算
- [ ] 验证空状态显示

### 2. 性能测试
- [ ] 大量数据加载性能
- [ ] 页面响应时间测试
- [ ] 并发访问测试

### 3. 兼容性测试
- [ ] 不同浏览器兼容性
- [ ] 不同设备屏幕适配
- [ ] 不同网络环境测试

### 4. 安全测试
- [ ] 未登录访问控制
- [ ] 接口安全性测试
- [ ] 数据验证测试
