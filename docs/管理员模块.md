# 管理员模块技术文档

## 模块概述

管理员模块提供完整的后台管理功能，包括用户管理、USDT充值审核、信用卡管理和业务参数配置。所有功能均通过RESTful API实现，并提供统一的Web界面。

## 系统架构

### 1. 权限控制

**实现机制：**
- 基于角色的访问控制（RBAC）
- 所有API端点均进行管理员权限验证
- 使用`Role`和`UserRoleRelation`模型管理权限关系

**权限验证流程：**
1. 检查用户登录状态
2. 查询管理员角色（name='admin'）
3. 验证用户是否具有管理员角色关联
4. 拒绝非管理员用户访问

### 2. API设计

所有管理员API均以`/api/admin/`为前缀，采用RESTful设计原则：
- 使用HTTP方法（GET, POST, PUT, DELETE）
- 统一的JSON响应格式
- 分页支持（page, per_page参数）
- 统一的错误处理

## 功能模块详解

### 1. 用户管理

**API端点：**
- `GET /api/admin/users` - 获取用户列表（分页）
- `PUT /api/admin/users/<user_id>/status` - 更新用户状态
- `PUT /api/admin/users/<user_id>/role` - 更新用户角色

**功能特性：**
- **用户状态管理**：支持启用/停用用户账户
- **角色管理**：支持添加/移除管理员权限
- **安全限制**：不能修改自己的状态和角色
- **分页查询**：默认20条/页，可配置

**数据结构：**
```json
{
  "id": 1,
  "username": "testuser",
  "email": "test@example.com",
  "status": "active/inactive",
  "roles": ["user", "admin"],
  "is_admin": true,
  "created_at": "2024-01-01 12:00:00"
}
```

### 2. USDT充值审核

**API端点：**
- `GET /api/admin/recharges` - 获取充值记录列表
- `GET /api/admin/recharges/<recharge_id>` - 获取充值详情
- `GET /api/admin/recharges/<recharge_id>/screenshot` - 获取充值截图
- `PUT /api/admin/recharges/<recharge_id>/review` - 审核充值

**功能特性：**
- **状态管理**：支持"审核中"→"已通过"/"已拒绝"状态转换
- **自动处理**：审核通过时自动增加用户余额
- **防重复提交**：已处理的充值记录不能再次审核
- **图片预览**：支持充值凭证图片放大查看

**审核流程：**
1. 展示所有USDT充值记录
2. 点击"审核"按钮查看详情
3. 查看充值凭证图片
4. 选择"通过"或"拒绝"操作
5. 系统自动更新状态和余额

### 3. 信用卡管理

**API端点：**
- `GET /api/admin/credit-card-generations` - 获取生成记录列表
- `GET /api/admin/credit-cards` - 获取所有信用卡
- `POST /api/admin/credit-card-generations` - 生成新信用卡

**功能特性：**

#### 3.1 信用卡生成记录
- 展示所有生成记录（生成时间、生成人员、数量、备注）
- 支持分页查询
- 按时间倒序排序

#### 3.2 所有信用卡
- 支持多条件查询（用户名、卡号模糊匹配）
- 展示详细信息（持卡人、有效期、卡号、安全码、状态等）
- 显示关联的生成记录信息

#### 3.3 信用卡生成功能
- **生成逻辑**：
  - 使用Faker库（en_US）生成真实美国人名
  - 生成符合Luhn算法的Visa信用卡号
  - 生成真实格式的3位安全码
  - 随机有效期（未来1-5年）
  - 默认状态为有效（recharge_status=True）

- **参数要求**：
  - 标题（title）：必填，用于描述生成批次
  - 数量（count）：1-1000张

- **技术实现**：
  ```python
  fake = Faker('en_US')
  card_number = fake.credit_card_number(card_type='visa')
  cardholder_name = fake.name()
  security_code = fake.credit_card_security_code(card_type='visa')
  ```

### 4. 业务参数配置

**API端点：**
- `GET /api/admin/configs` - 获取所有配置
- `PUT /api/admin/configs/<key>` - 更新配置值
- `GET /api/admin/support-emails` - 获取客服邮箱
- `PUT /api/admin/support-emails/<email_id>` - 更新客服信息
- `PUT /api/admin/support-emails/<email_id>/toggle` - 切换客服状态

**功能特性：**
- **配置管理**：支持查看和修改所有业务参数
- **客服管理**：支持多客服邮箱管理
- **状态切换**：支持启用/停用客服邮箱
- **在线编辑**：所有配置项均支持实时修改

## 前端实现

### 1. 界面布局
- 采用Tab式导航（用户管理、充值审核、信用卡管理、参数配置）
- 响应式设计，支持不同屏幕尺寸
- 统一的模态框组件（详情、确认、输入、结果提示）

### 2. 关键组件
- **数据表格**：支持分页、搜索、排序
- **模态框**：统一的弹窗管理系统
- **状态标签**：不同颜色表示不同状态
- **操作按钮**：统一的按钮样式和交互逻辑

### 3. JavaScript功能
- **数据加载**：异步加载所有数据
- **事件处理**：统一的事件绑定和处理
- **表单验证**：客户端验证输入数据
- **错误处理**：统一的错误提示和处理

## 技术实现细节

### 1. 信用卡生成逻辑

**核心代码：**
```python
def generate_credit_cards():
    # 初始化Faker，专门用于生成美国人名和信用卡信息
    fake = Faker('en_US')

    # 使用Faker生成真实的信用卡号（符合Luhn算法，自动生成Visa格式）
    card_number = fake.credit_card_number(card_type='visa')

    # 使用Faker生成真实的美国人名（更真实、更多样化）
    cardholder_name = fake.name()

    # 生成随机有效期（未来1-5年）
    expiry_date = (datetime.now() + timedelta(days=365 * random.randint(1, 5))).strftime('%m/%y')

    # 使用Faker生成真实的安全码（3位数字）
    security_code = fake.credit_card_security_code(card_type='visa')

    # 创建信用卡，默认状态为有效
    credit_card = CreditCard(
        cardholder_name=cardholder_name,
        expiry_date=expiry_date,
        card_number=card_number,
        security_code=security_code,
        recharge_status=True,  # 默认状态为有效
        generation_record_id=generation_record.id
    )
```

### 2. 权限验证装饰器

**统一验证逻辑：**
```python
def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        user = get_current_user()
        if not user:
            return jsonify({'success': False, 'message': '未登录'}), 401

        admin_role = Role.query.filter_by(name='admin').first()
        if not admin_role:
            return jsonify({'success': False, 'message': '管理员角色未配置'}), 500

        user_role_relation = UserRoleRelation.query.filter_by(
            user_id=user.id,
            role_id=admin_role.id
        ).first()

        if not user_role_relation:
            return jsonify({'success': False, 'message': '权限不足'}), 403

        return f(*args, **kwargs)
    return decorated_function
```

### 3. 分页查询实现

**统一分页处理：**
```python
page = request.args.get('page', 1, type=int)
per_page = request.args.get('per_page', 20, type=int)

query = Model.query.paginate(
    page=page,
    per_page=per_page,
    error_out=False
)

return jsonify({
    'data': [item.to_dict() for item in query.items],
    'pagination': {
        'page': page,
        'per_page': per_page,
        'total': query.total,
        'pages': query.pages
    }
})
```

## 依赖关系

### 1. 数据库模型
- User：用户信息
- Role：角色信息
- UserRoleRelation：用户角色关联
- Recharge：充值记录
- File：文件存储
- Config：业务参数配置
- SupportEmail：客服邮箱
- CreditCardGenerationRecord：信用卡生成记录
- CreditCard：信用卡信息

### 2. 外部依赖
- Flask：Web框架
- SQLAlchemy：ORM框架
- Faker：伪数据生成（用于信用卡生成）
- Flask-Login：用户认证

## 安全考虑

### 1. 权限控制
- 所有API均进行管理员权限验证
- 防止越权操作（不能修改自己的权限）
- 防止重复提交（充值审核状态检查）

### 2. 数据验证
- 客户端和服务器双重验证
- 防止SQL注入（使用ORM）
- 防止XSS攻击（模板自动转义）

### 3. 错误处理
- 统一的错误响应格式
- 事务回滚机制
- 详细的错误日志

## 使用说明

### 1. 访问管理员后台
- 登录系统后，访问`/admin`路径
- 系统自动验证管理员权限
- 无权限用户将被拒绝访问

### 2. 常见操作
- **用户管理**：查看、启用/停用、添加/移除管理员权限
- **充值审核**：查看充值记录、审核通过/拒绝
- **信用卡管理**：查看生成记录、查看所有信用卡、生成新信用卡
- **参数配置**：修改业务参数、管理客服邮箱

### 3. 注意事项
- 所有操作均有审计日志
- 重要操作需要确认
- 系统自动防止无效操作

## 扩展性

### 1. 添加新功能
- 遵循现有API设计模式
- 使用统一的权限验证机制
- 保持一致的响应格式

### 2. 自定义配置
- 通过Config模型添加新参数
- 通过SupportEmail模型添加新客服
- 通过Role模型添加新角色

### 3. 性能优化
- 使用缓存机制
- 优化数据库查询
- 实现异步任务处理
